      DOUBLE PRECISION FUNCTION DGAMMA(X)
      DOUBLE PRECISION X
      DOUBLE PRECISION DFLOAT, DSQRT, DLOG, DEXP, DSIN
      DOUBLE PRECISION PI, XBIG, DTCHBP, XMED
      DOUBLE PRECISION FACTOR, XX, YY, GAMINV
      DOUBLE PRECISION A(18), BIG, SMALL, CONST, D1MACH
      DOUBLE PRECISION P0, P1, P2, P3, P4, P5, P6
      INTEGER IWRITE, NTOTAL, N, MOD, NDEGR, I1MACH
C FOR X .LE.(-XMED), USE DGAMMA(X)*DGAMMA(1-X)=PI/SIN(PI*X)
C FOR (-XMED).LE.X.LE.1 AND 2.LE.X.LE.XMED, USE X*DGAMMA(X)=DGAMMA(X+1)
C FOR 1.LE.X.LE.2, USE CHEBYSHEV EXPANSION
C FOR XMED.LE.X, USE ASYMPTOTIC FORMULA
C CALCULATE INVERSE OF DGAMMA, THEN SEE IF IT IS INVERTIBLE,
C TO AVOID OVERFLOW.
      DATA A( 1)/+1.06377 30078 05261 97553 D0/
      DATA A( 2)/-0.00498 55872 86840 03595 D0/
      DATA A( 3)/-0.06419 25436 10915 82288 D0/
      DATA A( 4)/+0.00506 57986 40286 08725 D0/
      DATA A( 5)/+0.00041 66091 38709 68886 D0/
      DATA A( 6)/-0.00008 04814 12497 84711 D0/
      DATA A( 7)/+0.00000 29600 11775 18802 D0/
      DATA A( 8)/+0.00000 02689 75996 44060 D0/
      DATA A( 9)/-0.00000 00333 96463 06868 D0/
      DATA A(10)/+0.00000 00010 89653 86454 D0/
      DATA A(11)/+0.00000 00000 51385 01863 D0/
      DATA A(12)/-0.00000 00000 06600 74100 D0/
      DATA A(13)/+0.00000 00000 00247 69163 D0/
      DATA A(14)/+0.00000 00000 00002 20039 D0/
      DATA A(15)/-0.00000 00000 00000 67072 D0/
      DATA A(16)/+0.00000 00000 00000 03132 D0/
      DATA A(17)/-0.00000 00000 00000 00039 D0/
      DATA A(18)/-0.00000 00000 00000 00003 D0/
      DATA NTOTAL/18/
      DATA P0/+0.83333 33333 33333 33315 54247 D-1/
      DATA P1/-0.27777 77777 77768 16225 53 D-2/
      DATA P2/+0.79365 07935 00350 248 D-3/
      DATA P3/-0.59523 79913 04301 2 D-3/
      DATA P4/+0.84171 38778 1295 D-3/
      DATA P5/-0.19104 44077 728 D-2/
      DATA P6/+0.57083 83526 1 D-2/
      DATA PI/+3.14159 26535 89793 23846 D0/
      DATA NDEGR,XBIG,XMED,CONST,SMALL,BIG/0,0.D0,0.D0,0.D0,0.D0,0.D0/
C FIRST-TIME SWITCH
      IF (NDEGR .GT. 0) GOTO 7
         IF (I1MACH(14)+I1MACH(15) .LE. 0) GOTO 1
            SMALL = D1MACH(1)
            GOTO  2
   1        SMALL = (2.0D0*D1MACH(4)+1.0D0)/D1MACH(2)
   2     BIG = (1.0D0-2.0D0*D1MACH(4))*D1MACH(2)
         XMED = 12.0D0
         XBIG = DSQRT(D1MACH(2))
         CONST = DLOG(DSQRT(2.*PI))
         YY = 0.
         NDEGR = NTOTAL+1
   3     IF (YY .GE. D1MACH(3) .OR. NDEGR .LT. 4) GOTO  4
            NDEGR = NDEGR-1
            YY = YY+DABS(A(NDEGR))
            GOTO  3
   4     NDEGR = NDEGR-1
         IF (D1MACH(4) .GE. 1.D-20) GOTO 6
            IWRITE = I1MACH(2)
            WRITE(IWRITE,  5)
   5        FORMAT(49H DGAMMA IS NOT FULL PRECISION, BUT ONLY 20 DIGITS)
   6     CONTINUE
   7  XX = X
      IF (DABS(XX) .GE. XMED) GOTO 11
         FACTOR = 1.D0
   8     IF (XX .GE. 1.D0) GOTO  9
            FACTOR = FACTOR*XX
            XX = XX+1.D0
            GOTO  8
   9     IF (XX .LE. 2.D0) GOTO  10
            XX = XX-1.D0
            FACTOR = FACTOR*XX
            GOTO  9
  10     GAMINV = DTCHBP(NDEGR, A, XX, 1.0D0, 2.0D0)
         IF (X .LT. 1.D0) GAMINV = GAMINV*FACTOR
         IF (X .GT. 2.D0) GAMINV = GAMINV/FACTOR
         GOTO  14
  11     IF (X .LT. 0.D0) XX = 1.D0-X
C ASYMPTOTIC REGION
         IF (XX .LE. XBIG) GOTO 12
            GAMINV = 0.D0
            GOTO  13
  12        YY = 1.D0/XX**2
            GAMINV = DEXP((0.5D0-XX)*DLOG(XX)+XX-CONST-(P0+YY*(P1+YY*(
     1         P2+YY*(P3+YY*(P4+YY*(P5+YY*P6))))))/XX)
  13     CONTINUE
  14  IF (X .LE. (-XMED)) GOTO 17
         IF (DABS(GAMINV) .GE. SMALL) GOTO 15
C/6S
C           CALL SETERR(18H DGAMMA - OVERFLOW, 18, 1, 1)
C/7S
            CALL SETERR(' DGAMMA - OVERFLOW', 18, 1, 1)
C/
            GOTO  16
  15        DGAMMA = 1.0D0/GAMINV
  16     CONTINUE
         GOTO  20
C RANGE REDUCTION FOR SIN
  17     N = 0.5-X
         XX = X+DFLOAT(N)
         IF (MOD(N, 2) .EQ. 1) XX = -XX
         YY = DSIN(PI*XX)/PI
         IF (GAMINV .GT. DABS(YY)*BIG) GOTO 18
            DGAMMA = GAMINV/YY
            GOTO  19
C/6S
C 18        CALL SETERR(18H DGAMMA - OVERFLOW, 18, 1, 1)
C/7S
  18        CALL SETERR(' DGAMMA - OVERFLOW', 18, 1, 1)
C/
  19     CONTINUE
  20  RETURN
      END
